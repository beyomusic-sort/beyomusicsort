<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BEYOOOOONDS楽曲ソート</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui;
      background: #f4f4f8;
      margin: 0;
      display: flex;
      justify-content: center;
    }
    /* FC2バナー回避用に上＆右を少し空ける */
    .app {
      width: 100%;
      max-width: 900px;
      padding: 24px 14px 40px;
      margin-top: 40px;
      box-sizing: border-box;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    h1 {
      text-align: center;
      font-size: 1.9rem;
      margin: 6px 0 12px;
    }
    .sub {
      text-align: center;
      font-size: 0.9rem;
      color: #444;
    }
    .small {
      text-align: center;
      font-size: 0.75rem;
      color: #666;
      margin-top: 6px;
      line-height: 1.4;
    }
    .mode-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 12px;
    }
    button {
      border-radius: 999px;
      padding: 10px 18px;
      border: 1px solid #b4b4b4;
      background: white;
      font-size: 0.9rem;
      cursor: pointer;
      transition: .15s;
    }
    button:hover { background: #eee; }
    .primary { border-color:#007aff; color:#007aff; }
    .primary:hover { background:#e8f0ff; }

    .pair-container { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .option {
      flex:1;
      min-width:220px;
      background:#fafafa;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px;
      text-align:center;
      cursor:pointer;
      transition:.1s;
    }
    .option:hover { box-shadow:0 3px 12px rgba(0,0,0,0.06); transform:translateY(-2px); }

    .option-title { font-weight:600; font-size:1rem; line-height:1.4; }
    .option-sub { font-size:.8rem; color:#777; margin-top:6px; }

    .progress-bar {
      width:100%; height:8px; background:#ddd; border-radius:10px; margin:10px 0;
      overflow:hidden;
    }
    .progress-inner { background:#007aff; width:0; height:100%; transition:.25s; }
    .status { text-align:center; font-size:.9rem; }

    .results-list { list-style:none; padding:0; margin:0; }
    .results-list li {
      padding:6px 4px;
      border-bottom:1px solid #eee;
      display:flex;
      gap:10px;
      font-size:0.9rem;
    }
    .rank-num { font-weight:bold; width:26px; text-align:right; }

    /* スマホのときは右側に余白を作ってFC2バナーを避ける */
    @media(max-width:600px){
      .app{
        padding-right: 90px; /* 右上バナー分の空白 */
      }
      h1{ font-size:1.5rem; }
      .pair-container{ flex-direction:column; }
      button{ width:100%; margin:6px auto; max-width:300px; }
    }
  </style>
</head>
<body>
<div class="app">

  <!-- MODE SELECT -->
  <div class="card" id="startCard">
    <h1>BEYOOOOONDS楽曲ソート</h1>
    <p class="sub">モードを選択してください。</p>

    <div class="mode-buttons">
      <button class="primary" onclick="start(false)">BEYOOOOONDS楽曲ソート</button>
      <button onclick="start(true)">BEYOOOOONDS楽曲ソート（演劇女子部含む）</button>
    </div>

    <p class="small">
      ※上は通常モード（演劇女子部なし）<br>
      ※下は演劇女子部の楽曲も含むモードです。
    </p>
  </div>

  <!-- SORT UI -->
  <div class="card" id="compareCard" style="display:none;">
    <h1 id="modeTitle"></h1>

    <p class="sub">
      好きな曲を選択し続けることで自分だけのBEYOOOOONDS楽曲ランキングが作成できます。
    </p>
    <p class="small">
      音源リリース済みでメンバーが歌唱した楽曲のみ。<br>
      アルバム収録の寸劇のみ・歌唱無しのトラックなどは入っておりません。
    </p>

    <div class="status" id="statusText">0% 完了</div>
    <div class="progress-bar"><div class="progress-inner" id="progressInner"></div></div>

    <div class="pair-container">
      <div class="option" id="leftOption">
        <div class="option-title" id="leftTitle"></div>
        <div class="option-sub" id="leftAlbum"></div>
      </div>
      <div class="option" id="rightOption">
        <div class="option-title" id="rightTitle"></div>
        <div class="option-sub" id="rightAlbum"></div>
      </div>
    </div>

    <div style="text-align:center;margin-top:12px;">
      <button class="primary" id="tieBtn">引き分け</button>
      <button id="unknownBtn">選べない / 曲を知らない</button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card" id="resultCard" style="display:none;">
    <h1>結果</h1>

    <ol class="results-list" id="resultsList"></ol>

    <div id="unknownWrap" style="display:none;margin-top:16px;">
      <h3 style="margin-bottom:6px;font-weight:600;font-size:0.95rem;">選べなかった / 知らなかった曲</h3>
      <ul class="results-list" id="unknownList"></ul>
    </div>

    <div style="display:flex;gap:10px;margin-top:18px;flex-wrap:wrap;">
      <button class="primary" id="saveBtn">画像で保存</button>
      <button id="shareBtn">Xで共有</button>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  // ★ 集計先の Apps Script URL
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbycbtykQsGzq7MV_JFTJCV7Nb6SO9cKR3NcqEBYIM0bfXREjLN842j3eyx5MT-xatMFyQ/exec";

  // 元の楽曲リスト（BEYOOOOOND1St / 2NDS は後でアルバム表記に変換）
  const fullSongsRaw = [
    "眼鏡の男の子(1stシングル)",
    "Go Waist (1stシングル)",
    "ニッポンノD・N・A！ (1stシングル)",
    "文化祭実行委長の恋(1stシングル)",
    "アツイ！(BEYOOOOOND1St)",
    "伸びしろ〜Beyond the World〜(BEYOOOOOND1St)",
    "恋愛奉行(BEYOOOOOND1St)",
    "元年バンジージャンプ(BEYOOOOOND1St)",
    "恋のおスウィング(BEYOOOOOND1St)",
    "きのこたけのこ大戦記(BEYOOOOOND1St)",
    "こんなハズジャナカッター！(2ndシングル)",
    "ハムカツ黙示録(3rdシングル)",
    "ビタミンME(配信シングル)",
    "Now Now Ningen(2ndシングル)",
    "激辛LOVE (2ndシングル)",
    "フレフレエブリデイ(配信シングル)",
    "英雄〜笑って！ショパン先輩〜(3rdシングル)",
    "Never Never Knows〜コメ派とパン派のラブウォーズ〜(BEYOOOOOND2NDS)",
    "GOGO大臣(BEYOOOOOND2NDS)",
    "オンリーロンリー(BEYOOOOOND2NDS)",
    "虎視タンタ・ターン(BEYOOOOOND2NDS)",
    "Hey!ビヨンダ(BEYOOOOOND2NDS)",
    "求めよ…運命の旅人算(4thシングル)",
    "夢さえ描けない夜空には(4thシングル)",
    "WORKER讃歌(5thシングル)",
    "恋する銀河(5thシングル)",
    "Go City Go(5thシングル)",
    "フックの法則(5thシングル)",
    "あゝ君に転生(6thシングル)",
    "Oh!カンターレ(5thシングル)",
    "マイ・ファースト・ピアス(6thシングル)",
    "ディスコ・カーニバル(6thシングル)",
    "涙のカスタネット(BEYOOOOOND2NDS)",
    "灰toダイヤモンド(5thシングル)",
    "Do-Did-Done (6thシングル)",
    "都営大江戸線の六本木駅で抱きしめて(1st シングル)",
    "GIRL ZONE (1stシングル)",
    "そこらの奴とは同じにされたくない(BEYOOOOOND1St)",
    "We Need a Name! (BEYOOOOOND1St)",
    "高輪ゲートウェイ駅ができる頃には(BEYOOOOOND1St)",

    "不思議の国のアリスたち(演劇女子部「不思議の国のアリスたち」)",
    "みんなライバル(演劇女子部「不思議の国のアリスたち」)",
    "私のフィロソフィー(演劇女子部「不思議の国のアリスたち」)",
    "続いてる(演劇女子部「不思議の国のアリスたち」)",

    "あの頃(演劇女子部「アラビヨーンズナイト」)",
    "親友(演劇女子部「アラビヨーンズナイト」)",
    "S4 (演劇女子部「アラビヨーンズナイト」)",
    "アラビアン・ラプソディ(演劇女子部「アラビヨーンズナイト」)",
    "アラビヨーンズナイト(演劇女子部「アラビヨーンズナイト」)",

    "ワタシと踊りなさい！(2ndシングル)",
    "ヤバイ恋の刃(2ndシングル)",
    "二年前の横浜駅西口(2ndシングル)",
    "Get Back！ビニール傘の大冒険(BEYOOOOOND2NDS)",
    "循環(BEYOOOOOND2NDS)",
    "待ち合わせはJR梅田駅で(BEYOOOOOND2NDS)",

    "祈り(演劇女子部「眠れる森のビヨ」)",
    "朝が来た(演劇女子部「眠れる森のビヨ」)",
    "始まりの光(演劇女子部「眠れる森のビヨ」)",
    "青春を作ろう(演劇女子部「眠れる森のビヨ」)",
    "穏やかな時に包まれて(演劇女子部「眠れる森のビヨ」)",
    "みんなと歩こう(演劇女子部「眠れる森のビヨ」)",
    "永遠になればいいのに(演劇女子部「眠れる森のビヨ」)",
    "枯れた声(演劇女子部「眠れる森のビヨ」)",
    "眠れる森の美女の世界(演劇女子部「眠れる森のビヨ」)",
    "永遠になればいいのに2 (演劇女子部「眠れる森のビヨ」)",
    "永遠になればいいのに3 (演劇女子部「眠れる森のビヨ」)",
    "やりなおそう(演劇女子部「眠れる森のビヨ」)",
    "眠るあなた(演劇女子部「眠れる森のビヨ」)",
    "光と陰(演劇女子部「眠れる森のビヨ」)",
    "みんなと歩こう2 (演劇女子部「眠れる森のビヨ」)",
    "夜が来て、朝が来る(演劇女子部「眠れる森のビヨ」)",
    "夢の世界(演劇女子部「眠れる森のビヨ」)",

    "マリーのテーマ(演劇女子部「ビヨサイユ宮殿」)",
    "BURBOOOOONS 爆誕！(演劇女子部「ビヨサイユ宮殿」)",
    "メンバー紹介！(演劇女子部「ビヨサイユ宮殿」)",
    "ファーストステップ！！(演劇女子部「ビヨサイユ宮殿」)",
    "いじわるな二人(演劇女子部「ビヨサイユ宮殿」)",
    "みんなでひとつに(演劇女子部「ビヨサイユ宮殿」)",
    "繋がらない心(演劇女子部「ビヨサイユ宮殿」)",
    "君がいるから(演劇女子部「ビヨサイユ宮殿」)",
    "この愛をあなたに(演劇女子部「ビヨサイユ宮殿」)",
    "ルソーの授業(演劇女子部「ビヨサイユ宮殿」)",
    "やってみるんだ(演劇女子部「ビヨサイユ宮殿」)",
    "秘密(演劇女子部「ビヨサイユ宮殿」)",
    "あなたにしかできないこと(演劇女子部「ビヨサイユ宮殿」)",
    "なんどでも(演劇女子部「ビヨサイユ宮殿」)",
    "みんなのために(演劇女子部「ビヨサイユ宮殿」)",
    "フランスレボリューション(演劇女子部「ビヨサイユ宮殿」)",
    "フランスレボリューション(Ver2.) (演劇女子部「ビヨサイユ宮殿」)",

    "愛はまるで静電気(配信シングル)",
    "星の羊たち(Graduation Memorial CD)"
  ];

  const STAGE_KEYWORDS = [
    "演劇女子部",
    "眠れる森のビヨ",
    "アラビヨーンズナイト",
    "不思議の国のアリスたち",
    "ビヨサイユ宮殿"
  ];

  function isStageSong(str){ return STAGE_KEYWORDS.some(k=>str.includes(k)); }
  function cleanSong(str){
    return str
      .replace(/BEYOOOOOND1St/gi,"1stアルバム")
      .replace(/BEYOOOOOND2NDS/gi,"2ndアルバム");
  }
  function parseSong(str){
    const t = str.split("(")[0];
    const m = str.match(/\((.*?)\)/);
    return { title:t, album:m ? m[1] : "" };
  }

  let pool=[], ranked=[], unknown=[], idx=0, low=0, high=0, mid=0, candidate="";
  let currentModeIncludeStage=false;

  const startCard   = document.getElementById("startCard");
  const compareCard = document.getElementById("compareCard");
  const resultCard  = document.getElementById("resultCard");
  const modeTitle   = document.getElementById("modeTitle");
  const statusText  = document.getElementById("statusText");
  const progressInner = document.getElementById("progressInner");
  const leftOption  = document.getElementById("leftOption");
  const rightOption = document.getElementById("rightOption");
  const leftTitle   = document.getElementById("leftTitle");
  const leftAlbum   = document.getElementById("leftAlbum");
  const rightTitle  = document.getElementById("rightTitle");
  const rightAlbum  = document.getElementById("rightAlbum");
  const resultsList = document.getElementById("resultsList");
  const unknownWrap = document.getElementById("unknownWrap");
  const unknownList = document.getElementById("unknownList");
  const saveBtn     = document.getElementById("saveBtn");
  const shareBtn    = document.getElementById("shareBtn");

  function start(includeStage){
    currentModeIncludeStage = includeStage;

    startCard.style.display="none";
    compareCard.style.display="block";
    resultCard.style.display="none";

    let list = fullSongsRaw.slice();
    if(!includeStage){
      list = list.filter(s => !isStageSong(s));
    }
    pool = list.map(cleanSong).sort(()=>Math.random()-0.5);

    ranked = [];
    unknown = [];
    idx=0;

    ranked.push(pool[0]);
    idx=1;
    updateProgress();

    modeTitle.textContent = includeStage
      ? "BEYOOOOONDS楽曲ソート（演劇女子部含む）"
      : "BEYOOOOONDS楽曲ソート";

    nextStep();
  }

  function updateProgress(){
    const percent = Math.floor((idx / pool.length) * 100);
    statusText.textContent = `${percent}% 完了`;
    progressInner.style.width = percent + "%";
  }

  function nextStep(){
    if(idx >= pool.length){
      finish();
      return;
    }
    candidate = pool[idx];
    low = 0;
    high = ranked.length;
    ask();
  }

  function ask(){
    if(low >= high){
      ranked.splice(low,0,candidate);
      idx++;
      updateProgress();
      nextStep();
      return;
    }
    mid = Math.floor((low+high)/2);
    showPair(candidate, ranked[mid]);
  }

  function showPair(a,b){
    const L = parseSong(a);
    const R = parseSong(b);
    leftTitle.textContent = L.title;
    leftAlbum.textContent = L.album;
    rightTitle.textContent = R.title;
    rightAlbum.textContent = R.album;
  }

  leftOption.onclick = () => { high = mid; ask(); };
  rightOption.onclick= () => { low  = mid+1; ask(); };
  document.getElementById("tieBtn").onclick = () => { low=mid+1; high=mid+1; ask(); };
  document.getElementById("unknownBtn").onclick = () => {
    if(!unknown.includes(candidate)) unknown.push(candidate);
    idx++;
    updateProgress();
    nextStep();
  };

  function finish(){
    compareCard.style.display="none";
    resultCard.style.display="block";

    resultsList.innerHTML = "";
    ranked.forEach((s,i)=>{
      const li = document.createElement("li");
      li.innerHTML = `<span class="rank-num">${i+1}.</span><span>${s}</span>`;
      resultsList.appendChild(li);
    });

    if(unknown.length){
      unknownWrap.style.display="block";
      unknownList.innerHTML = "";
      unknown.forEach(s=>{
        const li = document.createElement("li");
        li.innerHTML = `<span class="rank-num">-</span><span>${s}</span>`;
        unknownList.appendChild(li);
      });
    }else{
      unknownWrap.style.display="none";
    }

    sendResultToSheet();
  }

  // CORS を避けてGASに結果を送る
  function sendResultToSheet(){
    if (!ENDPOINT_URL) return;

    const payload = {
      mode: currentModeIncludeStage ? "stage" : "normal",
      ranked: ranked,
      unknown: unknown,
      ua: navigator.userAgent
    };

    try {
      fetch(ENDPOINT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(payload)
      });
      // no-corsなのでレスポンスは読めないけど送信はされる想定
    } catch (e) {
      console.warn("送信処理エラー(無視OK):", e);
    }
  }

  saveBtn.addEventListener("click", ()=>{
    html2canvas(resultCard).then(canvas=>{
      const a=document.createElement("a");
      a.href=canvas.toDataURL("image/png");
      a.download="BEYOOOOONDS_sort_result.png";
      a.click();
    });
  });

  shareBtn.addEventListener("click", ()=>{
    if(!ranked.length) return;
    const top = ranked.slice(0,5)
      .map((s,i)=>`${i+1}. ${s.split("(")[0]}`)
      .join(" / ");
    const text = `BEYOOOOONDS楽曲ソート 結果\n${top}`;
    const url  = location.href;
    const shareUrl =
      "https://twitter.com/intent/tweet?text=" +
      encodeURIComponent(text) +
      "&url=" +
      encodeURIComponent(url);
    window.open(shareUrl,"_blank");
  });
</script>
</body>
</html>