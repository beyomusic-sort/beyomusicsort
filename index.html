<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BEYOOOOONDS楽曲ソート</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --accent: #007aff;
      --bg: #f4f4f8;
      --card-radius: 18px;
      --shadow-soft: 0 5px 20px rgba(0,0,0,0.05);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 560px;
      padding: 16px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-soft);
      padding: 22px 18px 24px;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin: 4px 0 10px;
      letter-spacing: 0.06em;
      line-height: 1.3;
    }

    .sub {
      text-align: center;
      font-size: 0.9rem;
      color: #444;
      margin: 0 4px;
      line-height: 1.5;
    }

    .note {
      text-align: center;
      font-size: 0.7rem;
      color: #666;
      margin-top: 10px;
      line-height: 1.5;
      opacity: 0.9;
    }

    .mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      padding: 12px 18px;
      border: 1.5px solid #b4b4b4;
      background: #fff;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, box-shadow 0.1s, border-color 0.1s;
      font-weight: 500;
      width: 100%;
      max-width: 360px;
    }

    .btn.primary {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn:hover {
      background: #f4f4f4;
    }

    .btn.primary:hover {
      background: #e8f0ff;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .pair-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 14px;
    }

    .option {
      background:#fafafa;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px 12px;
      cursor:pointer;
      transition: background 0.15s, box-shadow 0.1s, transform 0.1s;
      text-align:center;
    }

    .option:hover {
      background:#fdfdfd;
      box-shadow:0 3px 12px rgba(0,0,0,0.06);
      transform:translateY(-1px);
    }

    .option-title {
      font-weight:600;
      font-size:1rem;
      line-height:1.5;
      word-break:keep-all;
    }

    .option-sub {
      font-size:.8rem;
      color:#777;
      margin-top:4px;
      line-height:1.4;
    }

    .progress-bar {
      width:100%;
      height:8px;
      background:#ddd;
      border-radius:10px;
      margin:10px 0 4px;
      overflow:hidden;
    }

    .progress-inner {
      background:var(--accent);
      width:0;
      height:100%;
      transition:width .25s;
    }

    .status {
      text-align:center;
      font-size:.85rem;
      margin-top:4px;
    }

    .bottom-link {
      margin-top:16px;
      text-align:center;
      font-size:0.8rem;
    }

    .bottom-link a {
      color: var(--accent);
      text-decoration: none;
    }

    .bottom-link a:hover {
      text-decoration: underline;
    }

    .results-list {
      list-style:none;
      padding:0;
      margin:8px 0 0;
    }

    .results-list li {
      padding:6px 4px;
      border-bottom:1px solid #eee;
      display:flex;
      gap:8px;
      font-size:0.9rem;
      line-height:1.5;
    }

    .rank-num {
      font-weight:bold;
      width:26px;
      text-align:right;
    }

    #unknownWrap h3 {
      margin:14px 0 6px;
      font-size:0.95rem;
    }

    /* 結果カード上部のボタン配置 */
    .result-actions {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .result-actions .btn {
      width:auto;
      max-width:none;
      padding:8px 14px;
      font-size:0.85rem;
    }

    .creator {
      margin-top: 18px;
      text-align: center;
      font-size: 0.8rem;
      color: #777;
    }
    .creator a {
      color: #007aff;
      text-decoration: none;
    }
    .creator a:hover {
      text-decoration: underline;
    }

    @media (min-width: 640px) {
      .pair-container {
        flex-direction: row;
      }
      .option {
        flex:1;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.6rem;
      }
      .card {
        padding: 18px 14px 22px;
      }
      .btn {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
<div class="app">

  <!-- MODE SELECT -->
  <div class="card" id="startCard">
    <h1>BEYOOOOONDS楽曲ソート</h1>
    <p class="sub">モードを選択してください。</p>

    <div class="mode-buttons">
      <button class="btn primary" onclick="start(false)">BEYOOOOONDS楽曲ソート</button>
      <button class="btn" onclick="start(true)">BEYOOOOONDS楽曲ソート（演劇女子部含む）</button>
    </div>

    <p class="note">
      音源リリース済みでメンバーが歌唱した楽曲のみ。<br>
      アルバム収録の寸劇・歌唱無しのトラックなどは入っておりません。
    </p>

    <div class="creator">
      製作者 <a href="https://x.com/beyomusicsort" target="_blank" rel="noopener noreferrer">@beyomusicsort</a>
    </div>
  </div>

  <!-- SORT UI -->
  <div class="card" id="compareCard" style="display:none;">
    <h1 id="modeTitle"></h1>

    <p class="sub">
      好きな曲を選択し続けることで自分だけのBEYOOOOONDS楽曲ランキングが作成できます。
    </p>

    <div class="status" id="statusText">0% 完了</div>
    <div class="progress-bar"><div class="progress-inner" id="progressInner"></div></div>

    <div class="pair-container">
      <div class="option" id="leftOption">
        <div class="option-title" id="leftTitle"></div>
        <div class="option-sub" id="leftAlbum"></div>
      </div>
      <div class="option" id="rightOption">
        <div class="option-title" id="rightTitle"></div>
        <div class="option-sub" id="rightAlbum"></div>
      </div>
    </div>

    <div style="text-align:center;margin-top:12px;display:flex;flex-direction:column;gap:8px;align-items:center;">
      <button class="btn primary" id="tieBtn">引き分け</button>
      <button class="btn" id="backBtn" disabled>ひとつ戻る</button>
    </div>

    <div class="bottom-link">
      <a href="#" class="back-home">トップページへ戻る</a>
    </div>

    <div class="creator">
      製作者 <a href="https://x.com/beyomusicsort" target="_blank" rel="noopener noreferrer">@beyomusicsort</a>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card" id="resultCard" style="display:none;">

    <!-- ここが上部ボタン（横並び・右寄せ） -->
    <div class="result-actions">
      <button class="btn primary" id="saveBtn">結果を画像保存</button>
      <button class="btn" id="shareBtn">Xで結果を共有</button>
    </div>

    <!-- 結果タイトルはボタンの下 -->
    <h1>結果</h1>

    <ol class="results-list" id="resultsList"></ol>

    <div id="unknownWrap" style="display:none;">
      <h3>知らない にした曲</h3>
      <ul class="results-list" id="unknownList"></ul>
    </div>

    <div class="bottom-link">
      <a href="#" class="back-home">トップページへ戻る</a>
    </div>

    <div class="creator">
      製作者 <a href="https://x.com/beyomusicsort" target="_blank" rel="noopener noreferrer">@beyomusicsort</a>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  // ★ 集計先の Apps Script URL（最新）
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxVu5Y0TDyzDl3kRP_s1v9qt4N0xzkc-iXgb9s7XgB4HxU8wyRMDvqOKj5OcAE5FJfEWA/exec";

  // ----- 楽曲データ -----
  const fullSongsRaw = [
    "眼鏡の男の子(1stシングル)",
    "Go Waist (1stシングル)",
    "ニッポンノD・N・A！ (1stシングル)",
    "文化祭実行委長の恋(1stシングル)",
    "アツイ！(BEYOOOOOND1St)",
    "伸びしろ〜Beyond the World〜(BEYOOOOOND1St)",
    "恋愛奉行(BEYOOOOOND1St)",
    "元年バンジージャンプ(BEYOOOOOND1St)",
    "恋のおスウィング(BEYOOOOOND1St)",
    "きのこたけのこ大戦記(BEYOOOOOND1St)",
    "こんなハズジャナカッター！(2ndシングル)",
    "ハムカツ黙示録(3rdシングル)",
    "ビタミンME(配信シングル)",
    "Now Now Ningen(2ndシングル)",
    "激辛LOVE (2ndシングル)",
    "フレフレエブリデイ(配信シングル)",
    "英雄〜笑って！ショパン先輩〜(3rdシングル)",
    "Never Never Knows〜コメ派とパン派のラブウォーズ〜(BEYOOOOOND2NDS)",
    "GOGO大臣(BEYOOOOOND2NDS)",
    "オンリーロンリー(BEYOOOOOND2NDS)",
    "虎視タンタ・ターン(BEYOOOOOND2NDS)",
    "Hey!ビヨンダ(BEYOOOOOND2NDS)",
    "求めよ…運命の旅人算(4thシングル)",
    "夢さえ描けない夜空には(4thシングル)",
    "WORKER讃歌(5thシングル)",
    "恋する銀河(5thシングル)",
    "Go City Go(5thシングル)",
    "フックの法則(5thシングル)",
    "あゝ君に転生(6thシングル)",
    "Oh!カンターレ(5thシングル)",
    "マイ・ファースト・ピアス(6thシングル)",
    "ディスコ・カーニバル(6thシングル)",
    "涙のカスタネット(BEYOOOOOND2NDS)",
    "灰toダイヤモンド(5thシングル)",
    "Do-Did-Done (6thシングル)",
    "都営大江戸線の六本木駅で抱きしめて(1st シングル)",
    "GIRL ZONE (1stシングル)",
    "そこらの奴とは同じにされたくない(BEYOOOOOND1St)",
    "We Need a Name! (BEYOOOOOND1St)",
    "高輪ゲートウェイ駅ができる頃には(BEYOOOOOND1St)",
    "ワタシと踊りなさい！(2ndシングル)",
    "ヤバイ恋の刃(2ndシングル)",
    "二年前の横浜駅西口(2ndシングル)",
    "Get Back！ビニール傘の大冒険(BEYOOOOOND2NDS)",
    "循環(BEYOOOOOND2NDS)",
    "待ち合わせはJR梅田駅で(BEYOOOOOND2NDS)",
    "最KOO DE DANCE(コラボレーションシングル)",

    "朝が来た(演劇女子部「眠れる森のビヨ」)",
    "始まりの光(演劇女子部「眠れる森のビヨ」)",
    "青春を作ろう(演劇女子部「眠れる森のビヨ」)",
    "みんなと歩こう(演劇女子部「眠れる森のビヨ」)",
    "永遠になればいいのに(演劇女子部「眠れる森のビヨ」)",
    "眠れる森の美女の世界(演劇女子部「眠れる森のビヨ」)",
    "永遠になればいいのに2 (演劇女子部「眠れる森のビヨ」)",
    "永遠になればいいのに3 (演劇女子部「眠れる森のビヨ」)",
    "枯れた声(演劇女子部「眠れる森のビヨ」)",
    "やりなおそう(演劇女子部「眠れる森のビヨ」)",
    "眠るあなた(演劇女子部「眠れる森のビヨ」)",
    "光と陰(演劇女子部「眠れる森のビヨ」)",
    "みんなと歩こう2 (演劇女子部「眠れる森のビヨ」)",
    "夜が来て、朝が来る(演劇女子部「眠れる森のビヨ」)",
    "夢の世界(演劇女子部「眠れる森のビヨ」)",

    "マリーのテーマ(演劇女子部「ビヨサイユ宮殿」)",
    "BURBOOOOONS 爆誕！(演劇女子部「ビヨサイユ宮殿」)",
    "メンバー紹介！(演劇女子部「ビヨサイユ宮殿」)",
    "ファーストステップ！！(演劇女子部「ビヨサイユ宮殿」)",
    "いじわるな二人(演劇女子部「ビヨサイユ宮殿」)",
    "みんなでひとつに(演劇女子部「ビヨサイユ宮殿」)",
    "繋がらない心(演劇女子部「ビヨサイユ宮殿」)",
    "君がいるから(演劇女子部「ビヨサイユ宮殿」)",
    "この愛をあなたに(演劇女子部「ビヨサイユ宮殿」)",
    "ルソーの授業(演劇女子部「ビヨサイユ宮殿」)",
    "やってみるんだ(演劇女子部「ビヨサイユ宮殿」)",
    "秘密(演劇女子部「ビヨサイユ宮殿」)",
    "あなたにしかできないこと(演劇女子部「ビヨサイユ宮殿」)",
    "なんどでも(演劇女子部「ビヨサイユ宮殿」)",
    "みんなのために(演劇女子部「ビヨサイユ宮殿」)",
    "フランスレボリューション(演劇女子部「ビヨサイユ宮殿」)",
    "フランスレボリューション(Ver2.) (演劇女子部「ビヨサイユ宮殿」)",

    "本当のわたし(演劇女子部「不思議の国のアリスたち」)",
    "不思議の国のアリスたち(演劇女子部「不思議の国のアリスたち」)",
    "女王のオーディション(演劇女子部「不思議の国のアリスたち」)",
    "呼び名(演劇女子部「不思議の国のアリスたち」)",
    "みんなライバル(演劇女子部「不思議の国のアリスたち」)",
    "心を叩くよう(演劇女子部「不思議の国のアリスたち」)",
    "私のフィロソフィー(演劇女子部「不思議の国のアリスたち」)",
    "続いてる(演劇女子部「不思議の国のアリスたち」)",
    "重い空気(ラベンダ＆ピンク) (演劇女子部「不思議の国のアリスたち」)",
    "重い空気(ブルー＆オレンジ) (演劇女子部「不思議の国のアリスたち」)",
    "重い空気(デイジー＆ホッピン) (演劇女子部「不思議の国のアリスたち」)",
    "わたしの主役(演劇女子部「不思議の国のアリスたち」)",

    "夢じゃない(演劇女子部「アラビヨーンズナイト」)",
    "アラビアン・ラプソディ(演劇女子部「アラビヨーンズナイト」)",
    "レッドムーン(演劇女子部「アラビヨーンズナイト」)",
    "最高の物語(演劇女子部「アラビヨーンズナイト」)",
    "悪の王(演劇女子部「アラビヨーンズナイト」)",
    "月には帰らない(演劇女子部「アラビヨーンズナイト」)",
    "S4 (演劇女子部「アラビヨーンズナイト」)",
    "どうしたらいいの(演劇女子部「アラビヨーンズナイト」)",
    "親友(演劇女子部「アラビヨーンズナイト」)",
    "ジラ(演劇女子部「アラビヨーンズナイト」)",
    "あの頃(演劇女子部「アラビヨーンズナイト」)",
    "願い(演劇女子部「アラビヨーンズナイト」)",
    "幾つもの夜をかけ(演劇女子部「アラビヨーンズナイト」)",
    "アラビヨーンズナイト(演劇女子部「アラビヨーンズナイト」)",

    "愛はまるで静電気(配信シングル)",
    "星の羊たち(Graduation Memorial CD)"
  ];

  const STAGE_KEYWORDS = [
    "演劇女子部",
    "眠れる森のビヨ",
    "アラビヨーンズナイト",
    "不思議の国のアリスたち",
    "ビヨサイユ宮殿"
  ];

  function isStageSong(str){ return STAGE_KEYWORDS.some(k=>str.includes(k)); }

  // BEYOOOOOND1St / 2NDS をアルバム表記に置換
  function cleanSong(str){
    return str
      .replace(/BEYOOOOOND1St/gi,"1stアルバム")
      .replace(/BEYOOOOOND2NDS/gi,"2ndアルバム");
  }

  // 最後の () だけを収録先として扱う
  function parseSong(str){
    const lastOpen = str.lastIndexOf("(");
    const lastClose = str.lastIndexOf(")");
    if (lastOpen === -1 || lastClose === -1 || lastClose < lastOpen) {
      return { title: str.trim(), album: "" };
    }
    const title = str.slice(0, lastOpen).trim();
    const album = str.slice(lastOpen + 1, lastClose).trim();
    return { title, album };
  }

  let pool=[], ranked=[], unknown=[];
  let idx=0, low=0, high=0, mid=0, candidate="";
  let currentModeIncludeStage=false;
  let history = [];

  const startCard   = document.getElementById("startCard");
  const compareCard = document.getElementById("compareCard");
  const resultCard  = document.getElementById("resultCard");
  const modeTitle   = document.getElementById("modeTitle");
  const statusText  = document.getElementById("statusText");
  const progressInner = document.getElementById("progressInner");
  const leftOption  = document.getElementById("leftOption");
  const rightOption = document.getElementById("rightOption");
  const leftTitle   = document.getElementById("leftTitle");
  const leftAlbum   = document.getElementById("leftAlbum");
  const rightTitle  = document.getElementById("rightTitle");
  const rightAlbum  = document.getElementById("rightAlbum");
  const resultsList = document.getElementById("resultsList");
  const unknownWrap = document.getElementById("unknownWrap");
  const unknownList = document.getElementById("unknownList");
  const saveBtn     = document.getElementById("saveBtn");
  const shareBtn    = document.getElementById("shareBtn");
  const backBtn     = document.getElementById("backBtn");

  document.querySelectorAll(".back-home").forEach(a=>{
    a.addEventListener("click", e=>{
      e.preventDefault();
      goHome();
    });
  });

  function updateBackButton(){
    backBtn.disabled = history.length === 0;
  }

  function goHome(){
    startCard.style.display="block";
    compareCard.style.display="none";
    resultCard.style.display="none";

    pool=[]; ranked=[]; unknown=[];
    idx=0; low=0; high=0; mid=0; candidate="";
    history=[];
    statusText.textContent = "0% 完了";
    progressInner.style.width = "0%";
    updateBackButton();
  }

  function start(includeStage){
    currentModeIncludeStage = includeStage;

    startCard.style.display="none";
    compareCard.style.display="block";
    resultCard.style.display="none";

    let list = fullSongsRaw.slice();
    if(!includeStage){
      list = list.filter(s => !isStageSong(s));
    }
    pool = list.map(cleanSong).sort(()=>Math.random()-0.5);

    ranked = [];
    unknown = [];
    history = [];
    updateBackButton();

    idx=0;

    ranked.push(pool[0]);
    idx=1;
    updateProgress();

    modeTitle.textContent = includeStage
      ? "BEYOOOOONDS楽曲ソート（演劇女子部含む）"
      : "BEYOOOOONDS楽曲ソート";

    nextStep();
  }

  function updateProgress(){
    const percent = pool.length ? Math.floor((idx / pool.length) * 100) : 0;
    statusText.textContent = `${percent}% 完了`;
    progressInner.style.width = percent + "%";
  }

  function nextStep(){
    if(idx >= pool.length){
      finish();
      return;
    }
    candidate = pool[idx];
    low = 0;
    high = ranked.length;
    ask();
  }

  function ask(){
    if(low >= high){
      ranked.splice(low,0,candidate);
      idx++;
      updateProgress();
      nextStep();
      return;
    }
    mid = Math.floor((low+high)/2);

    history.push({
      idx,
      low,
      high,
      mid,
      candidate,
      ranked: ranked.slice(),
      unknown: unknown.slice()
    });
    updateBackButton();

    showPair(candidate, ranked[mid]);
  }

  function showPair(a,b){
    const L = parseSong(a);
    const R = parseSong(b);
    leftTitle.textContent = L.title;
    leftAlbum.textContent = L.album;
    rightTitle.textContent = R.title;
    rightAlbum.textContent = R.album;
  }

  leftOption.onclick = () => {
    high = mid;
    ask();
  };

  rightOption.onclick= () => {
    low  = mid+1;
    ask();
  };

  document.getElementById("tieBtn").onclick = () => {
    low = mid+1;
    high = mid+1;
    ask();
  };

  backBtn.addEventListener("click", () => {
    if(!history.length) return;
    const state = history.pop();
    idx = state.idx;
    low = state.low;
    high = state.high;
    mid = state.mid;
    candidate = state.candidate;
    ranked = state.ranked.slice();
    unknown = state.unknown.slice();
    updateProgress();
    updateBackButton();

    if (ranked[mid]) {
      showPair(candidate, ranked[mid]);
      compareCard.style.display="block";
      resultCard.style.display="none";
    }
  });

  function finish(){
    compareCard.style.display="none";
    resultCard.style.display="block";

    resultsList.innerHTML = "";
    ranked.forEach((s,i)=>{
      const parsed = parseSong(s);
      const li = document.createElement("li");
      li.innerHTML =
        `<span class="rank-num">${i+1}.</span>` +
        `<span><strong>${parsed.title}</strong><br><span style="font-size:0.8rem;color:#666;">${parsed.album}</span></span>`;
      resultsList.appendChild(li);
    });

    if(unknown.length){
      unknownWrap.style.display="block";
      unknownList.innerHTML = "";
      unknown.forEach(s=>{
        const parsed = parseSong(s);
        const li = document.createElement("li");
        li.innerHTML =
          `<span class="rank-num">-</span>` +
          `<span><strong>${parsed.title}</strong><br><span style="font-size:0.8rem;color:#666;">${parsed.album}</span></span>`;
        unknownList.appendChild(li);
      });
    }else{
      unknownWrap.style.display="none";
    }

    sendResultToSheet();
  }

  function sendResultToSheet(){
    if (!ENDPOINT_URL) return;

    const payload = {
      mode: currentModeIncludeStage ? "stage" : "normal",
      ranked: ranked,
      unknown: unknown,
      ua: navigator.userAgent
    };

    try {
      fetch(ENDPOINT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(payload)
      });
    } catch (e) {
      console.warn("送信処理エラー(無視OK):", e);
    }
  }

  saveBtn.addEventListener("click", ()=>{
    html2canvas(resultCard).then(canvas=>{
      const a=document.createElement("a");
      a.href=canvas.toDataURL("image/png");
      a.download="BEYOOOOONDS_sort_result.png";
      a.click();
    });
  });

  shareBtn.addEventListener("click", ()=>{
    if(!ranked.length) return;
    const top = ranked.slice(0,5)
      .map((s,i)=>`${i+1}. ${parseSong(s).title}`)
      .join(" / ");

    const text =
      `BEYOOOOONDS楽曲ソート 結果\n${top}\n\n` +
      `#BEYOOOOONDS #BEYOOOOONDS楽曲ソート @beyomusicsort`;

    const url  = location.href;
    const shareUrl =
      "https://twitter.com/intent/tweet?text=" +
      encodeURIComponent(text) +
      "&url=" +
      encodeURIComponent(url);
    window.open(shareUrl,"_blank");
  });
</script>
</body>
</html>
